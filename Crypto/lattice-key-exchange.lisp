;; lattice-key-exchange.lisp
;;
;; DM/RAL  2023/03/24 03:26:29
;; ----------------------------------

(defpackage #:com.ral.crypto.lattice-key-exchange
  (:use #:common-lisp #:lattice #:vec-repr #:hash #:ac)
  (:export
   #:lattice-skey
   #:lattice-pkey
   #:random-key
   #:make-aes-packet
   #:decode-aes-packet
   #:make-connection-to-server-packet
   #:make-connection-to-client-packet
   #:decode-server-connection-packet
   #:decode-client-connection-packet

   #:cnx-packet-encoder
   #:cnx-packet-decoder

   #:my-pkeyid
   #:srv-pkeyid
   ))

(in-package #:com.ral.crypto.lattice-key-exchange)

;; ----------------------------------
;;
;; Store skey seed in system keychain with:
;;  security add-generic-password -a $USER -s 'LispActorsSystem' -w <key>
;;
;; If you need to delete before adding:
;;  security delete-generic-password -a $USER -s 'LispActorsSystem'

(deflex lattice-skey
  (create
   (alambda
    ((cust)
     (flet (
            #+:MACOSX
            (get-seed ()
              (let ((txt (with-output-to-string (s)
                           ;; Using Mac KeyChain to hold secret keying
                           (sys:call-system-showing-output
                            "security find-generic-password -a $USER -s 'LispActorsSystem' -w"
                            :output-stream s))))
                (subseq (cadr (um:split-string txt :delims '(#\newline))) 2)))
            #+:WINDOWS
            (get-seed ()
              (with-open-file (f "~/.my-syzygy")
                (read f))) )
       (let ((me  self))
         (β (sys)
             (send lattice-system β)
           (let* ((seed (get-seed))
                  ;; (skey (lat2-gen-deterministic-skey sys seed))
                  (skey (flat-gen-deterministic-skey sys seed)))
             (send me cust :update skey) ))
         )))
    
    ((cust :update skey)
     (become (const-beh skey))
     (send cust skey))
    )))

(deflex lattice-pkey
  (create
   (lambda (cust pkey-id)
     (β (pkey)
         (send kvdb:kvdb β :find pkey-id)
       (when pkey ;; if not found, just drop things on the floor...
         (send cust pkey)))
     )))

(deflex lat2-encoder
  (create
   (lambda (cust pkey v)
     (β (sys)
         (send lattice-system β)
       (let ((enc (ignore-errors
                    ;; (lat2-encode pkey v sys)
                    (flat-encode pkey v sys)
                    )))
         (when enc
           (send cust enc)))
       ))
   ))

(deflex lat2-decoder
  (create
   (lambda (cust cs)
     (β (sys)
         (send lattice-system β)
       (β (skey)
           (send lattice-skey β)
         (let ((dec (ignore-errors
                      ;; (lat2-decode skey cs sys)
                      (flat-decode skey cs sys)
                      )))
           (when dec
             (send cust dec)))
         )))
   ))

;; ------------------------------------------------------
;; AES-256/CTR Encryption/Decryption

(defun random-key ()
  (vec (hash/256 :random-key (uuid:make-v1-uuid)
                 (prng:ctr-drbg 256))))

(defun aes-enc/dec (key iv vsrc)
  (let ((cipher (ironclad:make-cipher :aes
                                      :mode :ctr
                                      :key  key
                                      :initialization-vector iv)))
    (ironclad:encrypt-in-place cipher vsrc)
    vsrc))

(defun make-auth-chk (key iv cdata)
  (vec (hash/256 :chk key iv cdata)))

(defun make-iv (key)
  (subseq
   (vec (hash/256 :iv key (uuid:make-v1-uuid)))
   0 16))

(defun make-aes-packet (key &rest data)
  (let* ((vdata  (loenc:encode (loenc:unshared-list data)
                               :max-portability t))
         (iv     (make-iv key))
         (cdata  (aes-enc/dec key iv vdata))
         (chk    (make-auth-chk key iv cdata)))
    (list iv cdata chk)
    ))

(defun decode-aes-packet (key packet)
  (destructuring-bind (iv cdata &optional chk) packet
    (cond
     (chk ;; a normal packet
          (let ((chkx (make-auth-chk key iv cdata)))
            (when (equalp chkx chk) ;; just drop on the floor if not valid
              (let ((vdata  (aes-enc/dec key iv cdata)))
                (loenc:decode vdata)))
            ))
     (t ;; an unauthenticated packet used for initial handshake dance
        (let ((vdata  (aes-enc/dec key iv cdata)))
          (loenc:decode vdata)))
     )))

#|
   -----------------------------------------------------
   Secure Key Exchange
  
      client                                server
      --------------------------            ---------------------------
      Random Kc
      Ps = Lookup(SrvID)
      LatEnc(Ps, Kc), AES(Kc,CliID)  -->    Check CliID for membership
                                            Pc = Lookup(CliID)
                                            Random Ks
                                            Kses = H(Ks, Kc)
                                     <--    LatEnc(Pc, Ks)
      Kses = H(Ks, Kc)
  
      AES(Kses, Data)                -->
                                     <--    AES(Kses, Reply)
      ...
  
|#

(deflex cnx-packet-encoder
  (create
   (lambda (cust dest-pkeyid &rest info)
     (β (pkey) ;; if not found just drop things on the floor
         (send lattice-pkey β dest-pkeyid)
       (let* ((rkey       (random-key))
              (aes-packet (ignore-errors
                            (apply #'make-aes-packet rkey #|:canary|# info))))
         (when aes-packet
           (β (lat-enc)
               (send lat2-encoder β pkey rkey)
             (send cust rkey lat-enc aes-packet)
             )))))
   ))

(deflex cnx-packet-decoder
  (create
   (lambda (cust latcrypt aescrypt)
     ;; During handshake we exchange pairs of packets. The first is a
     ;; Lattice encrypted random key, the second is an AES encrypted
     ;; packet using that key.
     ;;
     ;; Return both the random key and the decrypted info.
     ;; Client/Server differ only in the contents of that info.
     (β (rkey)
         (send lat2-decoder β latcrypt)
       (let ((info (ignore-errors
                     (decode-aes-packet rkey aescrypt))))
         #|
         (when (and (consp info)
                    (eq (car info) :canary))
           (send cust rkey (cdr info)))
         |#
         (when (consp info)
           (send cust rkey info))
         )))
   ))

;; ----------------------------------------------------
;; For Actors-based code, using parallel Lattice encryption

(deflex my-pkeyid
  (create (lambda (cust)
            (send kvdb:kvdb cust :find :my-fpkeyid))
          ))

(deflex srv-pkeyid
  (const ;; "{d73be812-5309-11ee-9c10-f643f5d48a65}" ;; for 320x256 1-bit system
         ;; "{030DB608-B3D8-11EE-A642-80FF8DB0CE01}" ;; for 160x128 1-bit system
         "{B2DA77DC-B596-11EE-8E31-CB2DA3737401}" ;; for 160x128 8-bit system
         ))

#|
(inspect (ask lattice-system))
(inspect (ask lattice-skey))

(let* ((v (vec (hash/256 :test)))
       (sys (ask lattice-system))
       (skey (ask lattice-skey))
       (pkey (ask lattice-pkey (ask my-pkeyid)))
       (enc (flat-encode pkey v sys))
       (dec (flat-decode skey enc sys)))
  (assert (equalp v dec)))
|#

#|
;; ------------------
;; Public Key ID
(send kvdb:kvdb sink :add :my-fpkeyid "{B2DA77DC-B596-11EE-8E31-CB2DA3737401}")

;; ------------------
;; System Matrix  
(send kvdb:kvdb println :add :flat-system (fgen-sys))

(with-standard-io-syntax
  (prin1 (ask kvdb:kvdb :find :flat-system))
  (values))

;; ------------------
;; Public Key

(let* ((sys  (ask lattice-system))
       (skey (ask lattice-skey))
       (pkey (fgen-pkey skey sys)))
  (send kvdb:kvdb sink :add "{B2DA77DC-B596-11EE-8E31-CB2DA3737401}" pkey))

(with-standard-io-syntax
  (prin1 (ask kvdb:kvdb :find (ask kvdb:kvdb :find :my-fpkeyid)))
  (values))

;; ---------------------------------------------------------------------
;; To be used on foreign nodes...


;; Provide the System Matrix
(send kvdb:kvdb sink :add :flat-system
      '(:NBITS 320 :NCODE 256 :NROWS 320 :NCOLS 1 :MODULUS 2135987035920910082395021706169552114602704522356652769947041607822219725780640550022962086936379 :NNOISE 55 :MAT-A #(#(1876135832724627847806354675350466292962044006910228222185852488434532971750381116469181085052640) #(724876381676454407938719235293806819928690106796497795957395633343055296078195220518494311382794) #(1955866347061791591377966154206602819496826777414344415869666111697789114079861061947000116815259) #(364297633889778686153315136550630007922649955648554133779762054125117877329369412648239179566231) #(2069854486918296657537957851525826910410864227175645252252452848959451475337515278924638050716125) #(732492710292059718574584072925935516534941628573755015755183332808034588742227840682648588005302) #(1174993556402809324580859000319649023690229520047393484949389997021676025217028647472716124231385) #(218169914841458660762014708920270176347214655800859251634514231998870155136216485472176665688625) #(620123326132730542415428286867698263586189028190677310917921503869829669800963045899483934017533) #(406205261105989369565906881913274205913617317699878314069429745980021680261293095695067757806221) #(839460161776268854493603340407652515273754431381556773575682811899465427479890732047281536629611) #(442853413749349221292794662608336310208906773779828960717412295774315350234304574336862892361414) #(705953213250185729156653927021404562353843872719779511806976314086976500944052653004209838553622) #(733513191696386705680089923232060719008700559963797271287654323015184537086462498115967758056429) #(1943832786119578190371144825172739118069754551771978149854978655337763278479186864799971228019224) #(697939843386463895013440967104508037541620701548322853062260012918124206227214444803800984194910) #(98872989156669994671162805554416869502143508082280257856041171082008616257786559683233986207549) #(31747531683756931862327784987980101321237058723571734610073494962296696792429633953181810490561) #(1227848126245371058408353174704578783938505766203999230282621109141201437897730198188317252220964) #(1019466643482226584736176958102484303033581079202691957620982380363086016142887495483270995388866) #(1249621287732027413492849127963855413833070150326754143020779577376378246806584077696921679639806) #(1331452588885177135612509894693257559968023548511185385008236280684807447567937553686761720863301) #(179565606976082873882401208438164691596260558182518753003915328602558808449562022925511826771401) #(1795110796632383967236886881629672558251273353980322835630075605168622051770722451019035691857356) #(1746157226157969263979614697193629609033299644707044772328005037478676516623645545243338978724762) #(661429909280219805499534477525548352619766916164214987384401546536380699241964224328708893086179) #(566117098651719680509651232273616727842643587001346646696516421080963635716369590226631033168905) #(2119112501631018297047843279854632473946583909234104959772761445858889745778378835403278331472109) #(1779438418410481803884705302597511501414447620601602604355848458990919258290086497571246530163858) #(1702164384136136473493016410942640316794576960748241249366183016385713829001298443847036652471808) #(196601635698493451945190947253809398202471691662805950518026112327893805957171743802475907416501) #(1202840526850069112692781759656850613150354742181779038874040817366277845402777093579953729987800) #(160109956105865328948811433959503519225636503694732387537633843879386247934865285659572616843903) #(147927401360145626194207655864230707626935400121972000305918126047653442406715621797893453748718) #(466248191298632646882604521466967528178326501799833100617312261789091843340537620668596271711359) #(603756302397297118215208568379737366044110933843057569561392693659772718034946053730841081533150) #(47410067181199343009574768706771975658670910003689273205953277152484896392172776572189879292757) #(1714397404112432706139525143875300415101584263787494989331331414419492328228846570742844846174559) #(305107770261721434177699212983854746410538286206646202065330739403901374279636890734288728309438) #(700679329926800040006023121733457269912921476614832573194043311423432249712796865960320898045319) #(508645661500119064511720997243349469155403959189541177695871296479237133661561176868812929977435) #(1590689184998923505486247353466822647079229379212071439691229516031964039655067028632352840359960) #(1192682482573050214832920281280132622668223733891197019566163861487568343499111247125494615408831) #(2126018302607039532719800594326828132801036890864335549716820469215204895277162191177333562785713) #(1270501535975408048333837499778273275034693030548834858084600067548750970896117768258707152340286) #(1443484763821117134192357404934031054094873651607609975769481226062578889954468714676508691424441) #(1557515367705508171636724554382544897413544345088725936300310338918954516023633194826919429292112) #(543222160048302033058893423979102392654279889824171156257982701135370573248590022593114437220676) #(1812606772857197527733330971867573386552654203200510090100334373238272213718344858091963929741132) #(194785176291651721420547870150492943664016530970181429621923874422145077609283936546842173476733) #(20884154311864788591142435010963948328780484069229793144374498193386138164873498384551261004494) #(1751605835232172127959143189535282398194292667997340104649751180975274695839014992137209046524167) #(1807247039382057593944336517120838978312141214613522092965387071188992475256518066672193086562823) #(1788387126962938418889310377563145401708801051317717824679217349133586002335403812178995757861868) #(381529986177787419733622546630253884592485707089970970639146594607223010715354246604921906379404) #(824815996055486311841521069440070239937547530187290324876254616017674552586488425222365444549257) #(238609849697873011292780959100411520187579158588416756903690409014530064870450616096953659057707) #(1220828154339309502151840163235767225574215097571186433802691762645186036473252527642736107630411) #(543545931496136138558955160292099149786408524155635099055849295354159093125265303038185573043605) #(1731306115312040840814555724377000529327463247269143448555430150721515128396432757426592714380045) #(122767364285857143197752487891501399835996806167404475475231848346763529578178821868463920774924) #(454385141687887415857533935181998016156577117158162013690874264755315866687018714684669526042526) #(2125269800162158176789864154550776137685756093814680499597153025919873980502557095297067610744135) #(1942205016554927275730099363925227098756676960224333086587101758871836487649609072645873564138180) #(1305606119199255802379286870995904900790209116555703706337043334682925247049299669898208732060257) #(949098970599657917931240787253964202772761832188438613053127572523636414706596231960831818535976) #(419780580688652691419891433831102257692185851747664422992002718765364750749294995706467408811199) #(1979076516250967238351580848119880160173189363648378633948445594175312442290382060136675069100430) #(1320926120162887193571078557367018452031413831822612821047062381974801315502341270546140116848426) #(1758522061981808608757283927190930422038097624995495067904561838806793664939752741365676391409731) #(384999334603893939618151400648164344009750749929915809075024158900457352130706984919544681955299) #(572095919907783378352024185834847717647317263169533891605608369109779165411674237833261852199289) #(109151431371175695301261326304369983184489356089939188830250730455220619706986730822205049630304) #(2095905786541925155575476774894197120223340420945355702759951561232012840130519838932240198506380) #(1200969063972089723170910276668339742164762754757795142929840682403846572543856937426105605344875) #(974661361335175246636798739451054062275428171957500220716756941653088213647759829058415604883618) #(1132318908070809105831249509707137128225714304774971284999790897199402304438498053024334622891245) #(221516124954173653974429023071878461138683163847393572467554923814816151726135524929516906426954) #(351485083950649613907822584083257185843321374971142008653562574560493308509764380065249376406571) #(523024969314992648532463259302155174131498170342264309395146121844698340713066161903207835064069) #(1269510128866663507284889484261522185614099782821906565276694544317794326866525421845216602138469) #(329991791481041191359066395077216799348597823391034483664654292439408884092138008941055520175477) #(872161477382937712123583187607002708492922116567154352687869161578722225416694671628487354823995) #(24166658919825124676442566006551610574736521321287280233593573308276284006422866073666389881560) #(1313606443348428826857064649375577694357583721768449581744324789439103826455054397827583055985651) #(1743363966058007068487872608246505115189652707157490109781487198174763442090106215533338441200368) #(782154079530113221925240000203820306716383394570570345080921814871714494654468167287775547441633) #(1407296935370518471341318252353182716127070344974367936294552567967881389424163650491964251760089) #(615987792444462447637048775631452908947448878086060869624315066190911342021880403576833472917230) #(1740579547566006913856654077950449451507081873954616673763627853240187647737771972771675993032121) #(1598352003188156482122604313066076324930087947127702360226994686828973566111074009290812386927327) #(59512311169169133130690767145115946270116664221269366116750063236158141747846202077151579636269) #(896928370873242847217026272557041555906993791784406169920382015337364086006666779603069429039771) #(784274088081739942333420414584225990827479306973287198874959474100493676692701328288834948805418) #(1912285147607373224423005386283387600513866513658362360856614555288619608096247947580349040760706) #(1685305609485538050835698863625322046840851474064974242983235813927716355387900928176519659953086) #(1820398813029403428435962192046423971604642606105376594623158211588685489425159648788019109639586) #(463554037526657754296917317744409508911216413938346234688902369424091576008462640938551019183101) #(1421472983287166580709973934833862331309599283185692044560285835365654733101436582168782513794184) #(621587289844710095683891918361682205611522771538222821304730742994158891589203934966085102051969) #(1952208478292345108089536865558109456638055117895797190566219789335724434089275406560867226765043) #(1564911338329552074404994976034060611176210380669629775401020814015640719616730475488315838440850) #(644477998766584942022862269864664607071597967112828960347800914696803714123061895345772284732593) #(342763184938547530311763333065639963836438101493041441916326490430404859417695046582580072820651) #(2023065805336550991029232601359168222274955581786612256055603730909316662640848052831042395738049) #(1846892531176058202295887489910648701158313606998521444119548040830609903538187586014778311872066) #(2040783098548666076968128460964159925233315271799543427227314333991976149063802699046830809499724) #(1702044027968963810740631711340936557070882609824484304721510127286403349009558101784776130842908) #(1529076489995425295834921637921475268596269688967038991096672674694875836410054276553814354294233) #(1357732864126238265806511414474979885908565400471473275314431183524240389031071627471684219794119) #(2086258375566800873471662402784090505432477372067583512150638411543202738830589167955834183685985) #(1362516328290619090910677141852601621838068242705790004002061473019156132786778878868159171484366) #(1673122845985945868163021697273515022917946210275609412402320230486055374436176226312876928382124) #(1714873285278410697203463087753409947913443448733001351453139449926968268789288734045433644645647) #(1124414208355615374944185949940558823737326063919940223604097623147683196179494823587060747689961) #(1879758312361927213987724945441446522383094542784145884168122927704859465773177646689098046909299) #(339234323256790634309354562802986175863576061824457623198392749809560815943699561389402171052107) #(735376194873106504033236242407746275336239777522182829280538213236493855669136018899170786434936) #(22361222544951568386438956229405665144373688473943617905001748200061415918324838186982321414501) #(604211353540237405006625102405146481179638413741376363351948249989715338539302330082610490747105) #(1905172490484050775679921038849319154543857369804954437118918963598257066271946589643405244050207) #(621429488681409461246337564015688418792647432579845933062527864905340057449687335321532239296497) #(354115836845861943938440871848478725890115880734567842569069355062715989886068663159204206953389) #(540106109896299819502566352869344292208265226120361251826032925076601216411594073854538770383396) #(982933088720931140901814080053516285901880232387396463630779079682241932561793638827285677863747) #(1498107836428260453983969201021917369197011208970095766250596642341133465241601659458676122029710) #(1098168619634601627502428921598921593025941272086867303451057197929789720119545133608748017472914) #(90649319890873404736503772170169732293628986082635130215545543192752903131591203574687918271441) #(477064629392307575408715941980763077909730360193761047378291074484829354219519857680714450862747) #(181605378657512592357685055512201757024300374047357436651980031826211794715297722290728862585394) #(321471355390788609743954033909393848122803725060772380807217609839385221163515905534103439864314) #(98652787070873777636191114206665967431196189443536223353232293389533434627187725387039334716753) #(925342799383461839771181751233626223731720084792439433945900934421139226799434858336315937233763) #(421613305031989235553660155386507493907072079315939638895330937083163533250492524350369710745763) #(159710594640111939553445135343483248818468137344167753275994746601580565066845662410091180341345) #(490775018344377369955259478332000051833625668267827721307001024233973967215382940521111842633260) #(1608671658746355753428351946822569789553662966713831365165784084823833653068868492205156868904605) #(1131211690518625640303911364431879398791308268978253803092986495777771068945833332012690148921922) #(537670499148408725422397566644926162129443380835690205272831494665175435385494798035531174512984) #(1869903612003145573216755757658167992611796410561866848471703598353322670673791495343837096815361) #(1398442019735061017951114151792580579590625675701939813508746976009526590435299122062656397025078) #(184594801965843416684712417309792973916876809720327157085082223293421733214369583724896784020702) #(1381175851755243412709912911874192507111111752586772172672660766491867908395531961333185880414354) #(1010252397459146555955549834248930980560537925666317260112647399608959425389074637986094631938758) #(1143371844709736562742511756445384808601527547273265461480220588184451575164077880865306299878694) #(415621493687872122752352913731015827495671694260090331569053572511896812619202590139315378324713) #(44597556247493617054134165773062713612890422421621216539781111892085106202839016817582827255273) #(1635487798950768120081431538431665471824175641559515832746876133532717588974359527408268234203173) #(573862095208389550614921045015532985372245176866175765849647064066718306002393036716163507981305) #(793874224633902083163517140860755976355088127755598110259185068817621904957364879769020527373398) #(1189661479058549841042699983012985167496313562165300996361002801823265479919620107980184130444631) #(1825551005682553082005442611373613013617946026280368208967563287431581283807781992799873767049462) #(363024324501168299837949051032461186258839381039622067072865740014167926605294557786544061942504) #(48508369444855140067944321045976877217386024370140215982854546652775213637587760777719990115414) #(2104737190296415615434562540064610745901863064061023028353559930004724353911766100306155509071576) #(1595868527453592224120768421866608446308780552275648025811864763344840244800581639336839698872156) #(985414496322836686868629606490925139686063877654670209010915227056516882958415555476582054090580) #(88508239397159972832806235953782101253155641828724965798544360766671933910522759046211316479947) #(1848518201788150237017541228652621532864988746698254868933290222363393199652147085162466558144787) #(764356635886864477441833722164108645117959910861323460816739067021159560187984691340103546262331) #(427218013356892794118752712387299859741345595532159123141336599882126392028191684582455119428448) #(1425143134742893931678818395259687413793736682612783355820137869120118933766490707776598968837491) #(1799649409404460287979069918166130077260490532707344274674642629018465419502229662778842135087579) #(171730986220740757736060153036707184587487624126968387598497352865247162312785414645111462797275) #(1205930397311191461966510142345137055467183906862183470069761941410844207796560967390075258372074) #(422050880468144030532493098109621893358087865552426942328576660021186017504354334449893338921062) #(1354996408251776022220181482559218396835570305884977878761304055875464774576714951204228811012912) #(1165986994748129488644135339556559875138298779008591266447690529161906041062414876220963909863157) #(2133524402920753593886580708212173619346972599214107903287907996656111020824094019488748794341835) #(1607186576007460314954319776732810518610622267464285254541415764480224588607342142986763940626370) #(1103428883515106239331138479725544784691499432816134672784866714892986467787253551329466413539418) #(1327534745832608725565689343769066304235554758888938955859931837085016935085383794033760832328935) #(1619054249710236751591028474277336938124606654732723931326949734587333583262069729780176425899724) #(1113085516316906029501069669496800391806303863999187513731013540004284392132699409002017562807201) #(2001438664568041189452212192341739634688207097850701101741164251910141714124716266377560966511451) #(1688206021132537284604575333381914329656406873795123386642451485681731939624832619545178225224975) #(2061436785736566634628356738034294876150438510092327568866459776753854929241392602695004052338901) #(1076999865384213193605256410791095494420025670296712396789771509825895682432948556622095969483832) #(1397961033766323154916708693056206803559786465981230461870804830958382994473223684880103552179997) #(747572769871710179817845755209061202085427455072587120577670675920320842868070393135685085698076) #(142874134502868130463413015591827291134603169116265194714765389451296338912548807057436787019080) #(1141231149142753905013551271234350847276397431014502195270821993969666028748220617485167806541777) #(1767317027554246205913526153977092238042789228790144035082737715492945681921995735990294913551631) #(1949337120732758796652040585638745737453266827780423577377439088763070156545083064413119931040914) #(1337883730521722661715528451019041713004182969518867747481292978474366434583779104137667547586511) #(966681291259131189780786187396314822187963500712437063209210713863917884426336839406379967639336) #(956689525307715509227181442058427987893997169627327799301618036401108878978790893664709584288499) #(1707070236140560212851112224477492501610257080237228090099996485509033897626191114637865418010396) #(399246468177883485151989293920642725888062252443189220670776767972606468912255876037739175777935) #(1453688221816724340792824911667835538662192063242553368721014120797325729226505451683018204347694) #(1105858837187726431742027766370001440911043809334146696898328975155692036237620632503484917166032) #(1054445601186104883073137321588837255114038381797428261265161662705988729997021702813284333160517) #(558598981524229565749598627316392314011352583391788389924396895347941577227371872825050833195930) #(339629340335086498357868008848465998917640118051075374446627244832389161781626516014838378987272) #(1650012952112687404488676079808083341730728822511279050960795072815756996364082724195084129188411) #(885939569182528776684151770044368724669586222661528360978310508235177865388499213745356222893600) #(1361076735486456167314945245400073789706043663446152053997112160477489059515335049290364000063198) #(1676729421593075776437359289051746361076145040181023977727335576529183261070042023257997523439049) #(709525052523441970764485396566148596806883092210499266960758397108238950849450868156184182486137) #(1443537387617237799761353714953370164391001404971426637500479982578589201065674012532192487142978) #(1651636852571002448456131295186679391440608129910991120014179393325267707663422401044865856019419) #(1284775474473314866278621395957452693631554102984766794850646921152764757157768591113428115812829) #(1187162019560876990517832393314189504047387265486067408515084037132573194200861669722917341280911) #(1166455907730066244469302712444410231751771553881459028055692601564975926452851371582470455851038) #(161922805682504546313665636573224906750187209116195200185858783054468401540403516276085132227139) #(2020654318350163871685627195059157933383456634360411686162082636207674250010246368256519888083240) #(2133003824934145131886799384798514912538747348613704439768837683032938833567491266023734323540948) #(644255122749871375448422252626358296715427395874081647987373607408805631688198240112821130529909) #(2084583779562902372165886936663172334918845456295432185741368542792738380550611425295147449173140) #(703786732092359039294732440382005460593744502427096284258915459235989993860969959742095963605624) #(1108620530395903428155954456852661280163246475872230412877078541494223623863291317410685988379238) #(219728339034595806824615398984723479678424710509877870796070701582064886308846865151914402909728) #(2062238274710818338319969870682927062281806896515782195252063157265275718904657710192006225817945) #(1133920128760120978275814540611650674609902589146113109223743314564317154935094511190702434952679) #(129700376586885230359331491734609376290889426093437609527771678568380410562069458832331250879931) #(39812892190981445915335826034983160542824472466742708064707485167149375019326349050624384346762) #(1116179150374184184790401968829235455670583125199045750147718613650794593225756354149310445818924) #(740778219420250075150387603388781805367906364780549025530597578051693922664653214728961785780822) #(687953709826430513244284006816663201576971226666820738559093919356954702497939770131982774622262) #(637605588556526267659987788057318642190095671748837994804029745861716777822246250024265986106147) #(865598898899306063440820911882360004999419954972041777604530539794877752619830948150251396692639) #(457946050874375169778881854961570846239787939277495315545937533908238779561622947496966461377401) #(1094101336809249633767888694920192957785782055773264981455312847107262972493331675419335341036827) #(341541791648720866888617761619969322390426189283993217185823718698593489139070035349237593079047) #(272740044811438045932589936875197634055631218756398197179255742998679630623299548443777368590553) #(1953178340065977875548917971808092951180119604013268010807759145440183949969145909004263385754957) #(502739551080876743495095469765401196540050664037941123699863794812302102081252188577331526243540) #(2003929385249238416390723813436483630418023406477703348510697279700142228609901387903127545026077) #(1393994006795656424713325242126616064235547546641952357228213910362794889421189316770920582163794) #(573748925777052993418590647366280007286032663163085867427025777169149102820254715491936688252745) #(513751393690848951156900683086544919985267975572009122668467437428143238524962519263591511463806) #(1873992779297693816963365608607784436398301690281862489132334141062644106456317337106706633241687) #(493227946012241814324086435280644175934688884146618779120047377605532455332130716192584032295916) #(1607270203647313364655373875749571706042272413829435542517656538241474376545641031957582866097153) #(193702660125169222431553328106361759427039023490674022901607911942434073975531800698952710955719) #(199397916516435908704665087957751892733223095798869176492656179706471490037222145918577785104776) #(1709130874964132942435013739827223355255324511758986127416851206891961059053204939011337416805318) #(813093040098078271045745230170986469551463011943461389041516248897174681405448242189455297971227) #(1065698281182418762732552080922667159939962915444096936946575523023028385208029430125824879912422) #(18196588419367067957889728889486738612247420631871450361703862100788695764181475043852830206181) #(2039983410600910059395591736481732210669889143291446282299740010888795836753061076957439437273718) #(1489444149393264153435968649109413617619161796672403864640313944668251677503671784551978663436208) #(1677641780851782699029767242342344051734834459632968951144022694176964652236641256206233530099505) #(1025002518166267289499332808000951451590380366589231137918483338873600693730334716524399935822647) #(1288289635428475184746220311545796946701764616163478797694415244839514714070391803177591145893362) #(140219856170324901372080184508990287830527737392742081283730078839410843133210844718134093939604) #(85233883741336708444825404516610419900921671602387223301758403737163995529145554676374716797207) #(503538306532293353507782035709898390443932576056034383333466547601694783198918127865194435594383) #(596071838009167721074872429063611108458896892312735760875999415346539193937852724199309966515326) #(1304475297817994646324403176588061428325256851590826601524176161333755918467556919851458994977022) #(209314752166662994854144743005676654359889624387514870029047863912463830254938308996438672228052) #(1408550994538079218839330778707362259072668422603663273840976595763054286332354392145843606110978) #(1618715211155592991737595206210602595713506386678950567006443244066881839002858006336536866887362) #(833636477537630560210832440392032203782283053739898224038484701955714048600218030413850411688597) #(889514379916336979838148739887412322323559331478383647277174364503016623682290696701062722425183) #(1488912813245355516657484469223478970889184686958992420986073843486488841224284790092897294444196) #(810160216430963907089817291771961176258901017220133338344852626719446052394362023659347766035530) #(887367100845740079067622232024590576980085319885030283758463196182442340957267338245596009992345) #(1805204454458967544992722745778810398853411002240671770560787372356441982737149825338018993565987) #(1704659645017026462207224393184775372822060208703058427463694817846069830127575859304381767917475) #(756799922408695701888197278751566352687221707537880576736489556884932596808647752952320114809283) #(2016409224418165018300056027482745360243619773263013031426733541483772422168322828765803653502596) #(862148224742575197033720699615271511692310304875669943164827828160137349423145978111202452209589) #(1461212544542874897627060896338668569157289065312957311432542467394761647087346453142942329752431) #(297417706815150494406351621044314935484729335314171704443894492745820067814848497788692884799827) #(969451115331635259049802545311773304080062294477736387795101864935828762456605918881832820909792) #(14693213420635090849488971540176360038756049565277278240541078656835351668233587560805534989957) #(1234012113910800689630519240242939686999606217440519004998993927167098296152846622536656411629154) #(784466701503235871466829117139842830565784275468592258525144202960597672900364177581366654909914) #(1478474192000422788426426880718864498020539595740589599244751258417300916639935865573379986474600) #(1851861575017778808730843690083351004327899984235559782866919355557516222045208849480178431906767) #(386227812778856466791566591343126176915223074250763793422451395049594524954253711112045018827726) #(1551120782696722350992718202461754603333298873272214064882598737587193806797549871342932206121063) #(810255559416074165816780500379580658652466360374369715945349839601114049080304553018799892563348) #(1327988371369228861206468906543791900321713908464689434488377793933897955577334766650207821440369) #(705432522342120146947699480675157118442373560180521780955407211003700096744151947396824889687988) #(1765463633637008767061840619803470068185758813439385744758757661834568646737828273036074153536085) #(1178036378418846819185361301079766112900747540926947175891451310354359414851620291137214576277009) #(121796753724947345426299264422621734237951349186352372430886717448304685683202337490758669211889) #(1016124712181494065286165159022075196325245994011860434814759578721000914458436458995336406527127) #(2030640592649611591356637681666038868129594129896553193052359415086806439164893783149509609039010) #(780574726672091114792972258971067340216297837928028426543942149403813914569939954331614929182404) #(1973029747321184241886296818674521672988100537279395025347969983999475713960050905563902836653046) #(1420890592410902639718994059289755348761866643998367666485856914041040797207259225555062829657865) #(1262306730015987217361731357165683965635760632866994313149345984082494200643904603808189673803926) #(1309265193385665943403185934153123281889114724349565750307748949133494643787342032917906467627096) #(1020148435391129012124794635192194101844747366461176106407545500279672097422289058077916781291511) #(303934842574996199263176929599160785112345701910149165251524206834468628358051194503614778602735) #(1649401502642108209659601351555696863974835693319481958522245850761160584553047225893226109912004) #(683679975840661742909439733528520120394475101789713842502329949891393870924912825433633744408850) #(557523241627905218342699708676173675932520019446953853942692442311283867412943941627035181406326) #(26993780087049986393274995250106644447985863748664103957517034653639992037348657741861312621478) #(324327824421358285358193613228419420724415221607036654532621771781700433580133409712034093712759) #(27901163590984725575357942013467043778377230952091025775863907701777412048083796063362632185116) #(1674681832289224854668956510001690128601102724291688212396048175417491972746862381499220179623772) #(233840055833601725008065825968989014010710819479883400417613010620344593232451902159631871873105) #(1600589080860057369982038863876381711599969387391870581352169585777854329965882662332375778798714) #(1227712479483800254856331452103922963839682811727931853658004008537943338712409340241972245697145) #(672212794892724657800670368164663801597279985621335694309025664452755537186872887047619922848105) #(2029092723232359742208157386214696196461745674222684966040672752783258898899901341823967840686181) #(1490997644486475193519783429693841528642203937947163598872676683807999860878518164997703242231415) #(1091137018431550085289529514889259624745052746054923087620690796454035956240905656538505368512063) #(1697370910660475339920030793024051193912735238987926492094409006117035265080307258780853558683644) #(2026894856833522361380973370474499867785182294951027008310814729053252646381336428225040180067974) #(1354179848223183300988772393587754261850705765028833863876490018970520973050013394418769546424912) #(2081796788067434738405458855347103289399362623801479748502778356558996906719365345762358879928199) #(984231637494300138297369931450920127018063758398795018579441496666859171772696308271873134880794) #(1791767265960853931521429724920152206779426746620908572188311438677305155801552693590809252292636) #(236163567979438864538761888204631787242725957067865871853680538527581550254987299081157420843575) #(1715401735169720097779180364307398631639077926139682934216649839833355150123676659164524709285877) #(1703382296903536369801759428759565616260652722870191379112322098939109127837575631033477308135682) #(194470455150891372784053819015336369081414021317853037286954156035387652652076903160372327122995) #(759357548987584340900283246191676846677478112115395103968234928953922478397994584775676992586570) #(124813000723797971591248430983708997476248312991567507506405586389975752973028114832159421700105) #(312044835327832892220685035429103325406861341214063621853633920637109027060505347480477353346981) #(1844567279631181549661028145913027015172521849092513716655104298664758659534977569315633190339255) #(40029023261607361675385553196679115162787342634513216005593300667576136085324382530506581974165) #(642284647154763479854218903307583457646452183906402234019815965852034261673310054301298651668966) #(732353936201593625827334556512234238272484829154648167135894209251863671324949968926299947940107) #(144605203449605112063189136417866443248450502062601859851814360128928925427375471969513392863483))))


;; Provide the Public Key ID
(send kvdb:kvdb sink :add :my-fpkeyid "{B2DA77DC-B596-11EE-8E31-CB2DA3737401}")

;; Provoide the Public Key
(let* ((sys  (ask lattice-system))
       (skey (ask lattice-skey))
       (pkey (fgen-pkey skey sys)))
  (send kvdb:kvdb sink :add "{B2DA77DC-B596-11EE-8E31-CB2DA3737401}" pkey))

  ;; -----------------------------------------------------------------------------
|#

