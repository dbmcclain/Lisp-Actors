;; lattice-key-exchange.lisp
;;
;; DM/RAL  2023/03/24 03:26:29
;; ----------------------------------

(defpackage #:com.ral.crypto.lattice-key-exchange
  (:use #:common-lisp #:lattice #:vec-repr #:hash #:ac)
  (:export
   #:lattice-skey
   #:lattice-pkey
   #:random-key
   #:make-aes-packet
   #:decode-aes-packet
   #:make-connection-to-server-packet
   #:make-connection-to-client-packet
   #:decode-server-connection-packet
   #:decode-client-connection-packet

   #:cnx-packet-encoder
   #:cnx-packet-decoder

   #:my-pkeyid
   #:srv-pkeyid
   ))

(in-package #:com.ral.crypto.lattice-key-exchange)

;; ----------------------------------
;;
;; Store skey seed in system keychain with:
;;  security add-generic-password -a $USER -s 'LispActorsSystem' -w <key>
;;
;; If you need to delete before adding:
;;  security delete-generic-password -a $USER -s 'LispActorsSystem'

(deflex lattice-skey
  (create
   (alambda
    ((cust)
     (flet (
            #+:MACOSX
            (get-seed ()
              (let ((txt (with-output-to-string (s)
                           ;; Using Mac KeyChain to hold secret keying
                           (sys:call-system-showing-output
                            "security find-generic-password -a $USER -s 'LispActorsSystem' -w"
                            :output-stream s))))
                (subseq (cadr (um:split-string txt :delims '(#\newline))) 2)))
            #+:WINDOWS
            (get-seed ()
              (with-open-file (f "~/.my-syzygy")
                (read f))) )
       (let ((me  self))
         (β (sys)
             (send lattice-system β)
           (let* ((seed (get-seed))
                  ;; (skey (lat2-gen-deterministic-skey sys seed))
                  (skey (flat-gen-deterministic-skey sys seed)))
             (send me cust :update skey) ))
         )))
    
    ((cust :update skey)
     (become (const-beh skey))
     (send cust skey))
    )))

(deflex lattice-pkey
  (create
   (lambda (cust pkey-id)
     (β (pkey)
         (send kvdb:kvdb β :find pkey-id)
       (when pkey ;; if not found, just drop things on the floor...
         (send cust pkey)))
     )))

(deflex lat2-encoder
  (create
   (lambda (cust pkey v)
     (β (sys)
         (send lattice-system β)
       (let ((enc (ignore-errors
                    ;; (lat2-encode pkey v sys)
                    (flat-encode pkey v sys)
                    )))
         (when enc
           (send cust enc)))
       ))
   ))

(deflex lat2-decoder
  (create
   (lambda (cust cs)
     (β (sys)
         (send lattice-system β)
       (β (skey)
           (send lattice-skey β)
         (let ((dec (ignore-errors
                      ;; (lat2-decode skey cs sys)
                      (flat-decode skey cs sys)
                      )))
           (when dec
             (send cust dec)))
         )))
   ))

;; ------------------------------------------------------
;; AES-256/CTR Encryption/Decryption

(defun random-key ()
  (vec (hash/256 :random-key (uuid:make-v1-uuid)
                 (prng:ctr-drbg 256))))

(defun aes-enc/dec (key iv vsrc)
  (let ((cipher (ironclad:make-cipher :aes
                                      :mode :ctr
                                      :key  key
                                      :initialization-vector iv)))
    (ironclad:encrypt-in-place cipher vsrc)
    vsrc))

(defun make-auth-chk (key iv cdata)
  (vec (hash/256 :chk key iv cdata)))

(defun make-iv (key)
  (subseq
   (vec (hash/256 :iv key (uuid:make-v1-uuid)))
   0 16))

(defun make-aes-packet (key &rest data)
  (let* ((vdata  (loenc:encode (loenc:unshared-list data)
                               :max-portability t))
         (iv     (make-iv key))
         (cdata  (aes-enc/dec key iv vdata))
         (chk    (make-auth-chk key iv cdata)))
    (list iv cdata chk)
    ))

(defun decode-aes-packet (key packet)
  (destructuring-bind (iv cdata &optional chk) packet
    (cond
     (chk ;; a normal packet
          (let ((chkx (make-auth-chk key iv cdata)))
            (when (equalp chkx chk) ;; just drop on the floor if not valid
              (let ((vdata  (aes-enc/dec key iv cdata)))
                (loenc:decode vdata)))
            ))
     (t ;; an unauthenticated packet used for initial handshake dance
        (let ((vdata  (aes-enc/dec key iv cdata)))
          (loenc:decode vdata)))
     )))

#|
   -----------------------------------------------------
   Secure Key Exchange
  
      client                                server
      --------------------------            ---------------------------
      Random Kc
      Ps = Lookup(SrvID)
      LatEnc(Ps, Kc), AES(Kc,CliID)  -->    Check CliID for membership
                                            Pc = Lookup(CliID)
                                            Random Ks
                                            Kses = H(Ks, Kc)
                                     <--    LatEnc(Pc, Ks)
      Kses = H(Ks, Kc)
  
      AES(Kses, Data)                -->
                                     <--    AES(Kses, Reply)
      ...
  
|#

(deflex cnx-packet-encoder
  (create
   (lambda (cust dest-pkeyid &rest info)
     (β (pkey) ;; if not found just drop things on the floor
         (send lattice-pkey β dest-pkeyid)
       (let* ((rkey       (random-key))
              (aes-packet (ignore-errors
                            (apply #'make-aes-packet rkey #|:canary|# info))))
         (when aes-packet
           (β (lat-enc)
               (send lat2-encoder β pkey rkey)
             (send cust rkey lat-enc aes-packet)
             )))))
   ))

(deflex cnx-packet-decoder
  (create
   (lambda (cust latcrypt aescrypt)
     ;; During handshake we exchange pairs of packets. The first is a
     ;; Lattice encrypted random key, the second is an AES encrypted
     ;; packet using that key.
     ;;
     ;; Return both the random key and the decrypted info.
     ;; Client/Server differ only in the contents of that info.
     (β (rkey)
         (send lat2-decoder β latcrypt)
       (let ((info (ignore-errors
                     (decode-aes-packet rkey aescrypt))))
         #|
         (when (and (consp info)
                    (eq (car info) :canary))
           (send cust rkey (cdr info)))
         |#
         (when (consp info)
           (send cust rkey info))
         )))
   ))

;; ----------------------------------------------------
;; For Actors-based code, using parallel Lattice encryption

(deflex my-pkeyid
  (create (lambda (cust)
            (send kvdb:kvdb cust :find :my-fpkeyid))
          ))

(deflex srv-pkeyid
  (const ;; "{d73be812-5309-11ee-9c10-f643f5d48a65}" ;; for 320x256 1-bit system
         ;; "{030DB608-B3D8-11EE-A642-80FF8DB0CE01}" ;; for 160x128 1-bit system
         "{B2DA77DC-B596-11EE-8E31-CB2DA3737401}" ;; for 160x128 8-bit system
         ))

#|
(inspect (ask lattice-system))
(inspect (ask lattice-skey))

(let* ((v (vec (hash/256 :test)))
       (sys (ask lattice-system))
       (skey (ask lattice-skey))
       (pkey (ask lattice-pkey (ask my-pkeyid)))
       (enc (flat-encode pkey v sys))
       (dec (flat-decode skey enc sys)))
  (assert (equalp v dec)))
|#

#|
;; ------------------
;; Public Key ID
(send kvdb:kvdb sink :add :my-fpkeyid "{B2DA77DC-B596-11EE-8E31-CB2DA3737401}")

;; ------------------
;; System Matrix  
(send kvdb:kvdb println :add :flat-system (fgen-sys))

(with-standard-io-syntax
  (prin1 (ask kvdb:kvdb :find :flat-system))
  (values))

;; ------------------
;; Public Key

(let* ((sys  (ask lattice-system))
       (skey (ask lattice-skey))
       (pkey (fgen-pkey skey sys)))
  (send kvdb:kvdb sink :add "{B2DA77DC-B596-11EE-8E31-CB2DA3737401}" pkey))

(with-standard-io-syntax
  (prin1 (ask kvdb:kvdb :find (ask kvdb:kvdb :find :my-fpkeyid)))
  (values))

;; ---------------------------------------------------------------------
;; To be used on foreign nodes...


;; Provide the System Matrix
(send kvdb:kvdb sink :add :flat-system
      '(:NBITS 320 :NCODE 256 :NROWS 320 :NCOLS 1 :MODULUS 2135987035920910082395021706169552114602704522356652769947041607822219725780640550022962086936379 :NNOISE 58 :MAT-A #(#(1620493616291488182394105419960108263808380544595132869567693203238129799826550267602322572467921) #(1948403823633172271980599321501565420987196554308122769872242139807906028940288106185222805824995) #(610776356498237668525070742269602955002700247788681233553093746783435969454351224360605891634126) #(1459684555579850170037993894302892171656212873119120279804892088840010306150610157465383293298647) #(625113089832525608055433154457456052603690378791992792071061779508551974110020684543686964579359) #(789528822400903797071270386481836046359886397355935469092843777310614214953639749701140285303358) #(181998372804602504521551430223706261751727342134376493873180511339379286734466062623635695955117) #(1611668591479723087564314264760130623642030453360891719336046285832937806335924151042219416426867) #(1339256100092085834682676261037633291943124987628417605425316157823298388573542820693636806210602) #(709051801527917365545918870884806233545338744175332660264665404925327806551280109013350727743952) #(603869100829415198138913823964012657210829263725476693448600694168235656917623242745976024268438) #(88451516880907607916196144065922264413125604952011452997655764123883245540951788196165948057327) #(421980862715540827785769022376576325750901897496359126784222991479020385193512130646694317033530) #(729908194454018625838505255943888489277692677244613672828878063340376255117203586778730550592807) #(132494045072641164523551039519371012917320271495668544860397098579170156289536252212170109599384) #(1837149465158640951983233024968601220574558408290011839202849868486587125625634783808523527403335) #(778166154921115621473273433522890588748594448296613179968494496555149891714729667458444470907253) #(426385737766790375355357215753274575462663173211622482228229516524215516782170630722070043090152) #(755799510860495614814057755194535863021324389895259995936864349443789520502600326663365574376146) #(1381550683152917543754243162389608352403585408951263824212593704815858985837971485630461529945409) #(330112530555273187045523085737044434537975689765738026904739212881221165508443286743355442519605) #(29744485864387345479810376530652760327754776148871072493411070878349859448399477790888265383351) #(830448452101282922127652807125117962934763874280534197348031141781433333048793173692322004566773) #(819108795982760009210224708430116621061363332636547762117184126730512401795733641646984028884130) #(650663004593653580432220947162372120494661709582515509238615213994949327885342985703503517180991) #(1221904199705636128844638285988768834000226433931218036443188758857340701713657456686666851590871) #(1524078429968147515877441208752129585375350601661779140478680332393656249918296399023182017199360) #(1794002098840996044593576131698873092680169865911985556392663160337127412413476099470948569192480) #(1333921021560553102748500219419578346183957181636991981651686176755478289711300517901522325150278) #(694332131730080252236222862800622423411949053228794367415825285652950228776684311193752158352816) #(1997004739670022346907387128585816371459770704823474326495484458794129232997332307441493035779908) #(1578777949883906670897827318300059992650318455614920314378260629660552633282215106985491600589845) #(2129649481292295058047813241413740984270092020575178679369443431418163698717626580327881463505710) #(324265995726695497037834963160244732296492585578453990589874372691830905234492617064008374080839) #(1745815957100036932760079216677206005599493191328655343702430240480438696139334482870982746375758) #(1651527997992580192815403188708289601526723059265257108181185503219291285834426182329978264833451) #(858754242898542334612910798700581807451340324535671118730939103797882544719962497508688708118605) #(1419976523185446459854903167434485007528481048090126706372423512289984434572355064475699161161841) #(431721945111443182152412414177448787468119845778716987927214091531122350744589286287905843946525) #(411962357287051538892583989285511866623160208817750526962259697725961868506454067921297679451335) #(1907735326300029866172648154801610264881650188619117938087022743605203956672460497738084808456429) #(2123356379131839665414302901991453279243835000930329043334828221398656344346023602866136219803239) #(55610655957770864589799229102786483535298505284705948433649368893261281297437168264091147617304) #(2063713423201551638794043704712733984903543839235950174438121052375875411746079585012930253313183) #(2059087711612334296131755244101803810862704899583090906984367135458102362049591694133116503872645) #(745582790382244084731786378621685428324463649496479706810555590639657578431966872067885842942463) #(80420822739575244539350528109467171292935716446591644432352009983151743547114414908203301389518) #(2120007438535859997084593533272270803525821624640746676640129860369441347631882440790291483926571) #(2079159387854241078446666810179139543738611327340264245384187250983165331650759174653514641639) #(686038950167497545738457044824050209962018333972565601636131586359539419840569478885308168127343) #(152149785731232493996818088242108556143472692652452623239636182017180131607171132773366030299621) #(124520667525818863992995612716122354995803161256713210400289054000937999399069172000663885487030) #(540903989137639672422579972461678205543815863331541234198846811645482440883651463426097065257398) #(759817718661361106426486749134954395930027631348048291388824862556824920140346300914243493258585) #(913604947307533618609879648520549221464299804798944855133448175820555443034967207094723115865412) #(557503225201161683293002541640184486149296564823870444329004095988558126547155713945911421820577) #(461748186608237354626487027544778066061466622842521468368298075055758218214943005803229468082968) #(1538165277304371724451265616691018241662299945860395106446543698551495813038325927017010163983617) #(1325625353855045514752701672138492192128064658474866808298683430939122811866591637107383606690233) #(99822046336341911129213403763025359199657908469131155968029365201932152606974155701574214545388) #(1451517185622275845329954269781106935267545365006636631991465890603644423258916331692294326138551) #(104882147111367493144006142039971798331625677067007917689043550537220873014142390903677970722552) #(467611381165749615811566881445558768099260206031361121309387433199942808167928207580304873593367) #(1134601610753824054832290253951152045823156702484759949249867861903986228398171255409156029322155) #(1440584720644822605820132303256107992474900299474467319084606045635827347183852675892202359277696) #(1918622246583723453869270784922456975783699094023390910886380260173977782196244716192721055347476) #(1452526463655058971556315680436599100815033476642765007013456864766733876327368869599078732749399) #(1287584688254338759931429209643849959770224502114308112399814575269455990031767077185083211223538) #(943448038966355744078088298141044057600934307499527820569631332196564182739766781939170756603790) #(797049162018399144813294180645948749634244533083204626789939187535933033964631645219679104899046) #(2108170506847263354920066303335484462907087079468127290197202372045103776093496981436143750763794) #(2117589555721704263846829418531770643876531861199869366083344356067697053678714821793120030366267) #(1948191997101751974542006500152845653971461865986976224386428832958342635337488779026439489409943) #(1639107754941064699724996541793988820774796625563432599152097508367744991881049581201061050865029) #(1917988158701470918933189782673014898500524590344381872957421221844020382201122617508124971503168) #(102566002431323975161079253081735414664652999985193615615857605738742492570896185832070168258389) #(2081330649534277287061450825612652350480078665634883184169810761515815067616430007944953750909519) #(1638094621664495870159116512548836560079243352110124377109102979986816436625990583147455118204775) #(705551521033532627989336135116568507736964531732735412979981903811582519677166570236416297364) #(1737330690167020237768224623600116062785262530859227582654108104784529992677919899550662029792629) #(800815057849764790893236494819416042141374666761174236263957534808677386977309572839642854994997) #(128162475421430779381808511098048713659798581243090083968685211904637544079986461269336137877606) #(1765363995023324791313192063186075919313433073672492300919872645582985567252501239877615468839243) #(1187511653719974944702337846592019950982776614737827011058406443990047988706929936484716569889024) #(184282053228616563669802817469892172302060664795572530128219920866617427839198759741802952417834) #(551408781459813828539724287327024940082668049178765926844748488700368864472498528327308647621570) #(1900506250561622812590523638498705171528375779789858831453607421292584127903274134150209567621059) #(1157955078688537679786567480893366256293975457092027845294682247646169777701793960723436355915442) #(1598411722447187233868872314554907709339443350177143608517460271219527983940742162894691074106295) #(2051281741545338078877262995762181497789929905883524277188158391111185752277186167401793573948991) #(851633371481337987825539372752493237468536414961710467811240448874002125099635641054725230335332) #(383010926959388297641366839912816208029234937322693750191523731679834995718846471882918857901790) #(271876086324433399025127333887758250070751180914744676677830930710169051992232376522383042086187) #(784409534636266946279204978946468095815928781774321616480332375859730274643271829021074226944306) #(1957394481694625346848103683951656300644205779689497068953299678672085480003819951555525529023251) #(1480694320163185268407954106957292977005521548497982379430396149776226215072026591460979709010277) #(1495206671929889614610376583864622761872880857846109641161517783749618604809370066042881828835934) #(809962009060208532931583883839196478690562516414340344762371248831399774009253694447295072112175) #(848488503727879502004576204819081281978506773404416390144909491935355127728508354335257285677212) #(1674197563975297269738486905495168084595184403424932827839258705378649554841524544402419079889327) #(1813984879433369190090131534266654456981145608285596622547123879801584083786169558696438450374541) #(2112194008328389631206185828289661274486532734017560531623702005741317653729817479249914766221910) #(1379987426568877130746738966571803545287267391757853369430722567483853388679851258983059141181005) #(2020803092093047751568482743281716671696037156508154871940798401119924156280468945573292887521761) #(1617139427182797743297986256532739584524387784251985643079924335296380145817185215575371311516499) #(2090797958147157292165569691089431752998819240652932457274668749204230162885282057778450096084901) #(1540164167185238697926359726625350317450673544307249545568238964929861872064022320962673517911129) #(290331955034763151830641926338521814884743931122147997347056665074273614000895259660841267560384) #(594364528640247381368140332136483412707849908832924048678637947516620746050409093172138961034293) #(1261181434428769138201508604890334699621021428030196461915955143096872226505632304151777411676485) #(75768063349950477461655298300389686311808534117061209094387487503474254137829850216164171098320) #(66986671138600920039104197535621830679013055854776463007632344437142404740478746918509948598718) #(1486524835244968465187764275387540536293265884723284996570885612602729969998522750989835654340334) #(1040441501609292059061156452545144616569715558100658891703579207585824365378159297934948157198504) #(158988426706721357897856964602553714799034879716532528159915595867129640065047497158600246541543) #(584066496636035201178182225509997526621509038048962753304092581330608558647550984046943370414853) #(1221017774454857584418401733408872527794890309950181539810873046040806258313509386894816421101464) #(1569738253016982703440655575016905856634859435434060689716050461991079672169746584839378540745112) #(1153755573692872419519149058873920263125820287389297141316735987339746344096186153422481732162635) #(1751534959084376306876222741943356450606852335859811524441987192059942583298142056948220483205203) #(430481422122799713931061957162452065279301998454359959245038367864099499563956208780476151726736) #(1691194153738360470928620101183332423843293538367724614797425943899197644308707780733727006868967) #(249897402153878991232044468788328288471565123213125581406431950228064423688019786776084379340185) #(695851448531648712080593987721865419492187470886966534432164867823477884555611656082872007677157) #(1354904964566555200345422555626645919285111095316986027074290069221637915264997884899377631807902) #(917837139890676455756176317455938079237610950489702143549571259495252702755405543391919604133035) #(1988578485826142002100366672671138386589081980150204586770003015449826846757445649726552095115246) #(1045332715123092804264505782555688925143360859054944800547213313213339258379767952085623324953372) #(1355431466365065752274344297162152843761941807242913504862843632401066819821129484997253237155505) #(745908425604585009765031149205544836176675725965784258257703420156113089792567618651648289603250) #(2070957307551299144480277545627339193442629969594259969794984654470000823337253025402249439037572) #(1864821362081260195579014444330217748281269613550303994495342223896330218271528075229162816998241) #(951430253344056266025111075032007999719038449944885144526893318615811776490511895122670120493952) #(1929131488069649171194731395584636948829245981516621461465280575427659468478211666666683150162871) #(1618000021759564136413647562054286430253711457672109054391298586454763867825973761353320105825939) #(1284966340073330165061594836744200306420562253865033140889996136417907312180898078958156846447354) #(1315551264311984846614843957399101298258780360831458252529279818946708935039651606053604151566575) #(1739134345723991489147983628257570832829097967552650913197660672660211577930459966948856268291397) #(995684387816536364553556478547302290039254797043169154317586454661007014840149191393665988525688) #(810049726975475184797639872180568428279569181395851123820380715057829947885957884639794148073778) #(513460403478617028018089008245876750887944074051923551959304424233071333227264840573278398518440) #(1042790372657791442914850435179518291033565631304278351509499336241541958576983869979807741562623) #(2007960291060476990955320492530637879043264835810732769265940731158563072185258437352431572135541) #(122404755620270043923755779098411197883160646555287474946398578851741671169967699917970829379257) #(1828009324590360974835782608334198492956097701727749018025794343984600645043576585090835261478689) #(578543499594105004619483533368477837586937439554521794541205428558879084582043315810088263851738) #(1171846806035743608800765646009433849316646618877031464262842222220910716971413714492248577740601) #(668599052180004311828456508314428907340868914141707350336858975449351540802226356730334255724744) #(725818983435620907794697177132279806025116282031605995827620386294703896119462165009722733498196) #(810311775816039885850636458436706136675295322559368405205344801824321253453327548307344744842046) #(1519036305870683423156748726467703978446789172797453297594713920618697725221763461032090464407472) #(882900349816139032803129929312362102967611869668923128997892861601669782114469404593101143695855) #(215488532671598464744692811635051276950353740858631075249194873531615888775797933511392993438773) #(265803901065503584577352729369164287756604810074809592184068636170217065792866060985128208110850) #(338265969559787970468136293144796027108256484929215581585845566635386243093850821169997997018886) #(452262828365379579378213983682522150341609137412077979785210310166701863969652527495951047298994) #(2002617882090896557098924753513254224742542858227479428627799311128972928466850538554072146989204) #(1411371827956511706131808093165909250214780736559484579075089776175296632984996040039640099270899) #(1837419683703772495647989481411530143385828495203945000299166147353678592139869055488979210751898) #(1715051667071951004473740555615906395518491921881030774015746952143244452601452360706445615613677) #(1544793012253084941631008730901215547224130809083351759922332743565807869237749965217022839887377) #(1068276651866234770087287382404703043258624869958590682787439761399527269307116383720986215578361) #(163593029478583721966376425271951632753771251308956905588301958657707463317250171827445671849652) #(1358139446306450079821382804339970045602203189312028223124785868672280718497069153795819217185754) #(1956761529013189472672447996524986981660396175464689309823327764523036546946467744638983403358035) #(1310169362602434391523683243514264584038332808042068424957785915824395828130995399297198344848647) #(1933983313191359516801254812511010893401681944188800918087162255438551220911465305665068502316524) #(1524130576577521081118332145693294417031121876720391720810025516950254039910301640422081512554745) #(1643692196792977065272466927904018616109265034781192468371739621909012067400222520590343800431648) #(1327741572210304652120978129687981138396129607984320223279377757750791507031225066004793234376954) #(130241966553060362336484619690143528586308474546412064254839189809153379985467926523462326941941) #(1304328159311088344240746230926400863388419909508031428966177762217122895267987421101206943822499) #(325820456109562143663002772102288424028656267350126504120344185476164851706332825345787008375410) #(1294989916251534084578007516846095542988788591620295698347632462063601320177112302874160598063996) #(1088108076231701787753537566007584982341338546372748149546428683252495873642047490429489113188802) #(801429858819030363884586553074240084343713373279969561918629494782618274939583189886135728649795) #(175400739868901211684872357594808872584352706025956740001144985876512722744703851060241206094348) #(1315546138357345649911258297456413604536596859131741732022230906460658062878404479827365603694174) #(1195393476541382141779132551302631870558534178511754607108000933520331570304879641039469510037159) #(454518816284414699358901644675423908552546225146063602070710216347589733664894945659302851919569) #(271698006521095010309513606961772546278034270822143148968651847236651495114551283542615471894779) #(885338436136938024542482892941772213732156670827197743094889828808317746864733115033914016391940) #(890649456993087779460296241520950313874337800816346832696330047874200323981911284175528418277784) #(224704994621637395598671541732226970512522186564412656844996452557131552284350649175096262014051) #(1511417974170204617227285124806832843823907599652304973527455812538311682162243247095122690788058) #(540880517203718925286978300915645057787266455703008860993660334442158904719574027294007476779951) #(1422836504053227867671787521561218647231223127746569795188764471517742141121630093359160816729155) #(1009439860155447299411845963471684473416675615198267693864336401146922191959954479467104926314855) #(857792396492331617123539107728524435677923853246486590029333209458016678321728548243343835500452) #(1864790039749730597379860794436487874078370381964900124498814933797482762336512438091070643275938) #(1546385694764308636457822991366087276716607251470864503546425021344017509435614508061320645867065) #(746706535075703767307440566939754080573644323641055085041189141638966315993519291891477626749716) #(45347059269274041565867097603108948474643344480027135797743453257406274117647402178902262143675) #(731313164993733781820897672099286401375156050960411357348312505053399952361736832515665784251486) #(1293145185459684439461008088916968343002000870862667652541460215393950889511072457492923780417881) #(1081531461642499564964894143255565928475197815684953703888360520360173366192883773377153703000095) #(2086863119912481312624325321533260875128481364465305483037258459149932678178272393757182116671062) #(217214324308282473473811242109729217691032090553394966858334265232409282473096870543630999339370) #(412900847367215581169836163766183518382030723794436819998841090512792726561108130046094334465215) #(56875977458461096675161714028466615031206398303504100894819146628938197627506406892986783902707) #(2069381382465755904031656776545785278442043413950463431656615646496113028975090860604672218929863) #(154586337413836462152496192963712796718367927152444281242420609953666397293883140347958144133151) #(792910818407319820347855570359089625667940705102943493101965260491254643137718556472066741754637) #(1163938353258708634689257841498178363096570549254678624486341708247054401472703939562330794840814) #(755122431080382741362258978593060624837722401205767007544531131172010869936698107026037284137443) #(865968469615805937424285617975478754891631455477270158000714370868342429805348090084579491086321) #(944062452822786085859466271411985059739158209720750249960251661560076248063176283094756607908134) #(1171772412976125273363961784851361671871075766014521547062287659861479365895747996266031735092030) #(883868728424403032484719109364021684992149290151741622648371900869426440173110224883253029943453) #(1226810292906050436108829375867776047447599968916773037049053990835127187859253859464170983544859) #(1220597212874846831123290270360988012600380119083551729922734428112865228246356516743418397352351) #(262510646058977987209595814924151040412483125019447311277634154642662257701755722962431794899080) #(924237278898259126905708176981572039917741808973707161770741236539062099754268568749762191608212) #(1854613098860688509133765100617967680666653531546210206782755463429533103524609510126685484519607) #(176328737567726842925251986760574719260013895410273284474162554633532253534403598919878975125146) #(634433126898780140613325594002867327258914810543108624588958101084138170224115272890601925464958) #(190009780321291426342487196820477140339465888919589592840591908509944759284675793885296567814054) #(516440863081294646558361539889742582661694099540975800545382386539484570869076965886448882136772) #(1294482971972462945088407502430701361152563529142367706420859121068127152636150687017385658273979) #(863185156264488668961903079962657810471645393147685229201747506169407044237966272236289100412615) #(261395610487037768110550172777990394649801174815278720584200598141561857824848397764543040871405) #(2120014551900502645896485848823654041639910858720468294498644953782198334676493051103496451704124) #(564973967077376966499560999735946618486461710827274138895066500529952388789721377573376677199046) #(2099431882047506083876953541871554954992883910243054258548442444731077640435846444420276903811025) #(1222643198256335571188309409332460421225628430031699129927349137200746857343902793865875744230617) #(1468642686926096356461341750244022248425396580647346745713884551431378153114318085224980635932996) #(1874237847561791946697596902075754341866672017092379389873955756010018756774150447619465187874985) #(611173008541817376350096623663684077752078201357457093188583466315223709068633082434992766279943) #(1040769914622558742554365165836173347919665610790046988075178749570226225710383367413031374147289) #(1529772742300704730578058873457227734423384081094886063441701304441031272903735546935670678706573) #(738834091845432065386947862099265310405401481956449120563414947962468720775870557808105443622105) #(1974886538384317573976628406086717006119783734545876722795201674229767250624566561271958066096076) #(595529548406822081542508883442095437985767352250802204984531622169872606717903635501960879260100) #(513294072847883688413990337178434716487501681654294314703114262340590730189326195058450550748044) #(374562013077717156240549864920387114176746615694512076638698245515174169071732826678117441232010) #(423377608083575592404192918738180034405094487954574091231519160735861139491683363927374580330285) #(526576151285964337201339712819896332949993071595186255474984132628408397569354149721364427405723) #(556303716497774049698558842688005391097944682100987298574790371483576514362279146065524136272036) #(1868639119260914913329579364151876417912221328316385269234230163068687629556703834493652183559817) #(173702511362975170343713904475593265992096876973900264764950625758593532566895309516334591230750) #(1315508255677363530206602373843901921581057259188800297633524937220354527260097024441703744748061) #(486503310810644360547584099308158769008037602981733178001577519332399336426819696654394262993566) #(419679385280167036642874992445020086261726764443088488887161830314215802576738233619671991784813) #(1462358368311684674899786820167960960479290490267949781502638353727199401591625068608560635761480) #(2073635660799126441524130725762181243684172905437288568354352901115920745201451128081009268187917) #(1749360549761565803327935923136963887644748345775310186778728513197967015495533439340656239042704) #(1412141970861990945105454124575646658975060218442185023764756520091796483931030191452147559007734) #(946026754732310304836045723086797470309583382220387018422655783656018822657256793612787446504458) #(2087461353576993394786046348428817216772215930720126388957021210969419564775590842012743527906273) #(472883694068316582283307302238465443995841480673590180293459407710701155805781878379241748129960) #(720266442302682679884826612112935222856633344020460727075770041601444345149447483327717518402756) #(1356825304315769925748927760305240332710602448331179902913035252815274358531168892845390948274268) #(492004593135101363097357983965200045920558124615958702219524483118204537893249158665752793220096) #(1118307730771517107125544530009927094110379518043103028732188588535577805847618723903717245185600) #(1770164021647919069212239020600503980742847346555034081497757592188148512470787409999717262638420) #(271704897885869972248199523446573326160586015512965859492011326816384996708061187423296091749130) #(1687692351057743201189220162515696345697634677494079483786285005673697856749048466190139436830924) #(1048621715578204321741981342318621307952424382900113803918674703806174951219603539955261934707989) #(370847521654458430387622223257117292856176143616245921113157528371653518443104212824895454316658) #(1738638734854205821348720187736175688818361098377556781264865620049959972381627826415685571398398) #(54798800535105306212050192072959247623250089959074560560858385087156082733339494128877738587222) #(67390144492870741506850327206714532339786316299211068312187324478514058062485771629301176233337) #(1121038106053863894752377214276344473570610303969561572063042589049254490090145877528706455803324) #(863832262208879848160288935102607016992428821532689339832945887382944903988221919208196826643394) #(859664028703408560364752163037459944098141865757344043753896799926673323602590667332492935357311) #(1313693787953705293015498568010787755062099426452496059300510540302141764684405713508512272630214) #(892580381209394819619757554461965790348391455088441837973102466439822151542273841397785783808837) #(1836690126177384538875640983354035874537560933457948580354779676249385235044426815303683221373816) #(361179891766516628436309852305150084534572411770174858221576987037400502248727698392339709873102) #(540001207316194219011263871998709402151361024333289976785146201623116038718319373540940239686207) #(895942079425164550731002338738125662907732580272414149682295547057178106779012872971899753967215) #(1821849613800738356619981004719405267618222292492545776655010056400242313763538381947617838025360) #(1598127282559893607069542966103262077711405684460789433872935929503772434492426139710003352031734) #(1843803387906455019777143172169818789453016690081199652154609710213343998368362523105844150849660) #(1506038735245171287388327043550708364865484926285883120604826276602267781490524974116158826393411) #(1158549633978275584507526880102353202684994897436731830917220026548065948033010238081345039387101) #(1611061026434942446239074825001337989125016976638260126534940902362864764450143429918443110902060) #(1514979719027582698701906164706684805457437717903115932014528771774189755392209936713722239309181) #(1140398545290158319169459191411993872016570654462426909090323757611748253395231343640689027035874) #(554507172802605283547721126156358446489353708175585974314681475003212533867768502883883721601237) #(1100539859122724129932456031391058931846530730046722632697519134256920585772437519078653485414658) #(1862892315513831327900404720364535235131355975391700148070057709840421909514484306888819730853262) #(129614252865640273401967896016691023698360189721241672303245019389153520409933384030093388593972) #(454716863019713717878927128638860880456233793782072657603003882186624441595473170028132580679504) #(2117879816393225828539044238623185323692370000246044711168538216174870064761638494077601455757477) #(329855472791198058178417984134189138626613903319574793176850291210571219595053895566850104464963) #(460297574302148043180898136266240340873240494598347346029459775033642823586724457614862061290111) #(6861846703685779473331204986498525289228537860835810429933702356926549837617086146540901988021) #(2115689997494433802191123065717149846127408113346852594407466993194983125128008837740998859465182) #(746407494999503025186742791952870482550165801051104004900713924919110563823962412902365379330854) #(444551934991460355237867214999058345299196568026471019453872568584326568643673707068298347403525) #(1047792081812690433481147133458624926088256545306466543499705267736586785367089325166281175877013) #(644748347180793589314485015592947288905713719407816630226469630547189934836994691759924493296122) #(773709105989891202894150379570114997189607295261560360341693567630213532897094155659353187239979) #(146241902541145609348093485681944980379289114682401885709038645749044933103588011719174733577509) #(1862144152624396103180239252624639650726107283212519557044826483050056461968539246940195327850991) #(29362315334200437522723364856497815426715113960788030470465054639646743922885807391148531480701) #(1548109598529325703609268919433771715567541663358218802313056673597569982427592207530540617796625) #(973573603111294909394391457493539699048885289458576324239475988970609444665465600946759314428569) #(1729695435574667016687790131134347330734896310477113507659850379961712239998936434361490033014455) #(56559767675791177217540196686038963509169953941821633318629471870920385831438175759370490176103) #(530093658874151283734087361908864322266005633998194021069827000301842703297169093781614475813319) #(740318284993534223956355900936673021401077898947337981541927133448994617857484709149757762478707) #(1219819589355187721470810358779608038992643400050373613442259037401632033650109812346655189339498) #(1054090034038060525819855558982006276200367308690784756150934001856656373463179035455422496314070) #(1569472929250146028546992883102826781320163968080992361597696863277230783679991254574034492078887) #(557126374212678968576189217133298472471689199006947530176280825935415318455458273261619848846052) #(797140619317922996844173131212016512895515759027707180972677741390004816040031464387121764629615) #(203382145472243072250823499207002355524164874547112153240997393091875211133771258435917190887085) #(2005492426326452584626039182727663774054092435087301702854504618684379136700891610714185944628808) #(584000915329317471906845448714278440485462222028373063311632769422087185582356936914353152110899) #(770048049619231461360058881254591242296561865204816007703373818750707605724412946103231095030029) #(279426198506113089707400655342497688202149744836444512689895571395602709379827899460391192720939) #(1458640129719708392680088216957966524311018065667641823931356556240305852940629049444812683946673) #(770062255753971686397623635747437215537723315841641352497684691935076514066750554208637917876095) #(165379124181064528237533313462291112472858962658016398119192972774283617531736231468947554784987) #(1469419380845725956195155903781663111760277164441713945954114325697065819487935860257197470474897) #(1324221431953202417548209864765858775894788037428372557271147370950853350209973672548740937136737) #(1487577238905461064394011525460657563915866642531389131782107715257633192648913215693180110866202) #(693886956274445353732587390884645089087965118128202256765557101544083008390866151126203891839457))))


;; Provide the Public Key ID
(send kvdb:kvdb sink :add :my-fpkeyid "{B2DA77DC-B596-11EE-8E31-CB2DA3737401}")

;; Provoide the Public Key
(let* ((sys  (ask lattice-system))
       (skey (ask lattice-skey))
       (pkey (fgen-pkey skey sys)))
  (send kvdb:kvdb sink :add "{B2DA77DC-B596-11EE-8E31-CB2DA3737401}" pkey))

  ;; -----------------------------------------------------------------------------
|#

